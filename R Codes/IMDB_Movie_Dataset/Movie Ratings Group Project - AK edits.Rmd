---
title: "Movie Ratings Group Project"
author: "Group 5"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Importing Data
```{r}
rm(list=ls())
library(tidyverse)

movies <- read_csv("movies.csv")
ratings <- read_csv("ratings.csv")

str(movies)
str(ratings)
```
Null Checks:
```{r}
max(is.na(movies))
max(is.na(ratings))
```

## Data Preprocessing

Expanding Movies Dataset

```{r}
library(data.table)
movies <- data.table(movies)
dummy_movie_genre_expanded <- movies[, list(title,genres = unlist(strsplit(genres, split = "|", fixed = T))), by = movieId]

# remove spaces
dummy_movie_genre_expanded$genres <- str_trim(dummy_movie_genre_expanded$genres)
str(dummy_movie_genre_expanded)
```

Checking Movies with only one genre listed
```{r, eval = F}
movie_count_one <- movie_genre_expanded %>%
  group_by(movieId) %>%
  summarize(
    count = n()
  ) %>%
  filter(count == 1)
movie_count_one
```

3,041 movies have only one genre listed (29.4%)
*Might be able to perform a chi-squared goodness of fit test to see if there is any bias between movies with only one genre listed versus those with multiple genres*


Joining Datasets
```{r}
#movies_drop <- movies %>% select(-3)
#movies_join <- left_join(movie_genre_expanded, movies_drop, by = "movieId")
movie_ratings_expanded <- full_join(dummy_movie_genre_expanded, ratings, by = "movieId")
```

Subsetting Movies with one genre
```{r, eval=F}
one_genre <- inner_join(movies_join, movie_count_one)
one_genre
```

Finding proportion of genres
```{r,eval=F}
one_genre_prop <- one_genre %>%
  group_by(genres) %>%
  summarize(
    count = n(),
    prop = n() / 3041
  )

one_genre_prop <- one_genre_prop[order(one_genre_prop$prop, decreasing = T),]
one_genre_prop
```

```{r,eval=F}
all_movies_prop <- movies_join %>%
  group_by(genres) %>%
  summarize(
    count = n(),
    prop = n() / 10329
  )

all_movies_prop <- all_movies_prop[order(all_movies_prop$prop, decreasing = T),]
all_movies_prop
```

One genre category is missing the IMAX category
```{r,eval=F}
prop_join <- full_join(one_genre_prop, all_movies_prop, by = "genres")
prop_join <- rename(prop_join,
       count_one = count.x,
       prop_one = prop.x,
       count_all = count.y,
       prop_all = prop.y)
prop_join[is.na(prop_join)] = 0
prop_join
```

Doing a Chi-squared Goodness of fit test to see if proportions of one genre are different from all of the genres
```{r}
# chisq.test(prop_join$count_one, p = prop_join$prop_all)
```

Chi-squared test does not work because the proportion of genres does not equal 1 in the population dataset. We'll have to think of another way to see if these two stats are significantly different.   

Checking Dataset integrity and number of genres.
```{r}
unique(movie_ratings_expanded$genres)
sum(is.na(movie_ratings_expanded$genres))
```

20 different genres

Some issues with the final dataset:
* There are multiple genres per movie and multiple reviews per movie. This means the review ratings are duplicated in the final dataset in movies with multiple genres after they have been expanded. We might want to join the datasets with all genres listed in one column instead.
* Overlap of genres between different movies might cause some issues.
* The dataset is very long. We might want to subset it to those movies with just one genre (which would address the issue above), or perhaps narrow it down to a certain time frame.
* The timestamp variable is being interpreted as numeric. We will need to figure out how to fix this.

*Extract year from movie titles*

Columns to make:
* Average user ratings per movie
* Number of ratings per movie
* Year movie is made

```{r, eval=F}
genre_list <- list(unique(movies_join$genres))
for (g in genre_list) {
  movie_wide <- movies %>%
    mutate(
      g = if_else(grepl(g, movies$genres), 1, 0)
    )
}

str(movie_wide)
unique(movies_join$genres)
```

Creating New Variables
```{r}
dummy_movie_wide <- movies %>%
  mutate(
    Adventure = if_else(grepl("Adventure", movies$genres), 1, 0),
    Animation = if_else(grepl("Animation", movies$genres), 1, 0),
    Children = if_else(grepl("Children", movies$genres), 1, 0),
    Comedy = if_else(grepl("Comedy", movies$genres), 1, 0),
    Fantasy = if_else(grepl("Fantasy", movies$genres), 1, 0),
    Romance = if_else(grepl("Romance", movies$genres), 1, 0),
    Drama = if_else(grepl("Drama", movies$genres), 1, 0),
    Action = if_else(grepl("Action", movies$genres), 1, 0),
    Crime = if_else(grepl("Crime", movies$genres), 1, 0),
    Thriller = if_else(grepl("Thriller", movies$genres), 1, 0),
    Horror = if_else(grepl("Horror", movies$genres), 1, 0),
    Mystery = if_else(grepl("Mystery", movies$genres), 1, 0),
    `Sci-Fi` = if_else(grepl("Sci-Fi", movies$genres), 1, 0),
    IMAX = if_else(grepl("IMAX", movies$genres), 1, 0),
    War = if_else(grepl("Adventure", movies$genres), 1, 0),
    Musical = if_else(grepl("Musical", movies$genres), 1, 0),
    Documentary = if_else(grepl("Documentary", movies$genres), 1, 0),
    Western = if_else(grepl("Western", movies$genres), 1, 0),
    `Film-Noir` = if_else(grepl("Film-Noir", movies$genres), 1, 0),
    No_genre_listed = if_else(grepl("(no genres listed)", movies$genres), 1, 0)
  )
str(dummy_movie_wide)
```

```{r,eval=F}
#Code chunk for testing proportions
sapply(dummy_movie_wide, mean)
```


```{r}
dummy_rating_mean <- ratings %>%
  group_by(movieId) %>%
  summarize(
    mean_rating = mean(rating)
  )

movies_mean_rating <- left_join(dummy_movie_wide, dummy_rating_mean, by = 'movieId')
movie_genre_expanded_mean <- left_join(dummy_movie_genre_expanded,dummy_rating_mean,by ='movieId')
movies_mean_rating
movie_genre_expanded_mean
```

Expanding with Movie Ratings
```{r}
library(data.table)
#movies_mean_rating <- data.table(movies_mean_rating)
#movies_mean_rating_expanded <- movies_mean_rating[ , list(title,genres = unlist(strsplit(genres, split = "|", fixed = T))), by = movieId]

# remove spaces
#movies_rating_expanded$genres <- str_trim(movies_rating_expanded$genres)

# rejoining tables
#movies_rating <- select(movies_rating, -genres)
#movies_rating_expanded <- full_join(movies_rating_expanded, movies_rating, by = 'movieId')
#str(movies_rating_expanded)
```

Creating Year Variable
```{r}
movie_ratings_expanded$year <- str_sub(movie_ratings_expanded$title, start = nchar(movie_ratings_expanded$title)-4, end = nchar(movie_ratings_expanded$title)-1) %>% str_trim()
movie_ratings_expanded$year <- as.factor(movie_ratings_expanded$year)

movies_mean_rating$year <- str_sub(movies_mean_rating$title, start = nchar(movies_mean_rating$title)-4, end = nchar(movies_mean_rating$title)-1) %>% str_trim()
movies_mean_rating$year <- as.factor(movies_mean_rating$year)

movie_genre_expanded_mean$year <- str_sub(movie_genre_expanded_mean$title, start = nchar(movie_genre_expanded_mean$title)-4, end = nchar(movie_genre_expanded_mean$title)-1) %>% str_trim()
movie_genre_expanded_mean$year <- as.factor(movie_genre_expanded_mean$year)

str(movie_genre_expanded_mean)
```

## Data Visualization   

Since each movie can belong to multiple Genres, the rating given to that movie is counted towards all the Genres the movie is applicable to.   
```{r}
rating_by_genre <- movie_ratings_expanded %>%
  group_by(genres) %>%
  summarize(
    Count = n(),
    Mean = mean(rating, na.rm=T),
    SD = sd(rating, na.rm=T),
    Min = min(rating, na.rm=T),
    Max = max(rating, na.rm=T)
  )

rating_by_genre <- rating_by_genre[order(rating_by_genre$Mean, decreasing = TRUE),]
rating_by_genre
```

```{r}
rating_by_genre %>%
  ggplot(
    aes(
      x = fct_reorder(genres, Count, .desc = T),
      y = Mean
    )
  ) +
  geom_col(fill = "lightblue", color = "black") +
  labs(
    title = "User Movie Rating by Genre",
    x = "Genre",
    y = "Average User Rating (0-5)"
  ) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
However, the ratings given in each genre vary. Some genres can have a higher user contribution than others.   

Calculating Rating by Year
```{r}
rating_by_year <- movie_ratings_expanded %>%
  group_by(year) %>%
  summarize(
    Count = n(),
    Mean = mean(rating, na.rm=T),
    SD = sd(rating, na.rm=T),
    Min = min(rating, na.rm=T),
    Max = max(rating, na.rm=T)
  )

rating_by_year <- rating_by_year[order(rating_by_year$year),]
rating_by_year
```

```{r}
rating_by_year %>%
  ggplot(
    aes(
      x = year,
      y = Mean
    )
  ) + 
  geom_col(fill = "lightblue") +
   labs(
    title = "User Movie Rating by Year",
    x = "Year",
    y = "Average User Rating (0-5)"
  ) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90))
```

## Statistical Testing
Testing Adventure
```{r}
Adventure <- movies_mean_rating %>% filter(Adventure == 1)
Not_adventure <- movies_mean_rating %>% filter(Adventure == 0)

t.test(Adventure$mean_rating)
t.test(Adventure$mean_rating, Not_adventure$mean_rating)
```

95% Confidence Interval for Adventure Movies: 3.16 - 3.25.

Two-sample t-test has a p-value of 0.2, so we cannot reject null hypothesis that Adventure movies score higher than all other movies.

### Identifying the movie with the highest mean rating from sample space and calculating it's confidence interval.   
```{r}
# First getting an additional column in wide data to get count of number of distinct users who've rated each movie
dummy_rating_usercount <- ratings %>%
  group_by(movieId) %>%
  summarize(
    distinct_user_ratings = n_distinct(userId)
  )

movies_mean_rating_new <- left_join(movies_mean_rating, dummy_rating_usercount, by = 'movieId')

movies_mean_rating_new
```
We subset our wide data to ensure that we only include movies that have ~ 30 ratings provided across sample user population. This is to ensure we have enough data to calculate the confidence interval.        
```{r}
# This is to ensure we have enough data to calculate the confidence interval
dummy_subset <- movies_mean_rating_new[movies_mean_rating_new$distinct_user_ratings>30,]
dummy_subset
dummy_subset[which.max(dummy_subset$mean_rating),]
```
As we can see from above, movieId = 1172 having title as = 'Cinema Paradiso (Nuovo cinema Paradiso) (1989)' has received the highest averaged rating across total of 37 Users. For the sake of analysis, this becomes our highest rated movie.    

Now creating a subset that includes all user ratings for this movieId.
```{r}
movie_highestrated <- subset(movie_ratings_expanded,movieId==1172)
movie_highestrated
```
Now retrieving the T-interval for this movie with a default confidence level of 0.95.
```{r , results='markup'}
ttest <- t.test(movie_highestrated$rating)
ttest
```
Based on the above test, we can see that the average rating for the movie 'Cinema Paradiso (Nuovo cinema Paradiso) (1989)' lies in the interval [4.242887, 4.676032] for the entire User population with a confidence level of 95%.


## Now calculating the movie with the maximum mixed reviews. (We consider the movie with the highest standard deviation, having a user count > 30)
```{r}
rating_by_movie <- movie_ratings_expanded %>%
  group_by(movieId) %>%
  summarize(
    Count = n_distinct(userId),
    Mean = mean(rating, na.rm=T),
    SD = sd(rating, na.rm=T),
    Min = min(rating, na.rm=T),
    Max = max(rating, na.rm=T)
  )
rating_by_movie <- subset(rating_by_movie,Count>30)

rating_by_movie <- rating_by_movie[order(rating_by_movie$SD, decreasing = TRUE),]
rating_by_movie
```
From this table, we see that the movie with maximum Standard Deviation, and hence, maximum mixed reviews is movieId = 53996, which is the movie titled = `r movies[movies['movieId']==53996][2]`   



